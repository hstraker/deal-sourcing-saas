// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  sourcer
  investor
}

enum DealStatus {
  new
  review
  in_progress
  ready
  listed
  reserved
  sold
  archived
}

enum PackTier {
  basic
  standard
  premium
}

enum PaymentStatus {
  pending
  completed
  refunded
}

enum CommunicationType {
  email
  sms
  call
  note
}

enum DocumentType {
  epc
  floorplan
  title
  survey
  pack
}

enum VendorStatus {
  contacted
  validated
  offer_made
  offer_accepted
  offer_rejected
  negotiating
  locked_out
  withdrawn
}

enum ConversationDirection {
  inbound
  outbound
}

enum OfferStatus {
  pending
  more_info_sent
  accepted
  rejected
  counter_offered
  expired
  withdrawn
}

enum VendorDecision {
  accepted
  rejected
  more_info_requested
  counter_offer
}

enum ReservationStatus {
  pending
  fee_pending
  proof_of_funds_pending
  verified
  locked_out
  completed
  cancelled
}

enum InvestorPipelineStage {
  LEAD
  CONTACTED
  QUALIFIED
  VIEWING_DEALS
  RESERVED
  PURCHASED
  INACTIVE
}

enum InvestorActivityType {
  ACCOUNT_CREATED
  PROFILE_UPDATED
  DEAL_VIEWED
  DEAL_FAVORITED
  PACK_REQUESTED
  PACK_VIEWED
  PACK_DOWNLOADED
  RESERVATION_MADE
  RESERVATION_CANCELLED
  PURCHASE_COMPLETED
  COMMUNICATION_SENT
  COMMUNICATION_RECEIVED
}

enum PipelineStage {
  NEW_LEAD
  AI_CONVERSATION
  DEAL_VALIDATION
  OFFER_MADE
  OFFER_ACCEPTED
  OFFER_REJECTED
  VIDEO_SENT
  RETRY_1
  RETRY_2
  RETRY_3
  PAPERWORK_SENT
  READY_FOR_INVESTORS
  DEAD_LEAD
}

enum SMSDirection {
  inbound
  outbound
}

enum SMSStatus {
  queued
  sent
  delivered
  failed
  undelivered
}

enum UrgencyLevel {
  urgent
  quick
  moderate
  flexible
}

enum PropertyCondition {
  excellent
  good
  needs_work
  needs_modernisation
  poor
}

enum ReasonForSale {
  relocation
  financial
  divorce
  inheritance
  downsize
  other
}

model User {
  id                        String    @id @default(uuid())
  email                     String    @unique
  passwordHash              String?   @map("password_hash")
  role                      UserRole
  firstName                 String?   @map("first_name")
  lastName                  String?   @map("last_name")
  phone                     String?
  profilePictureS3Key       String?   @map("profile_picture_s3_key")
  createdAt                 DateTime  @default(now()) @map("created_at")
  lastLogin                 DateTime? @map("last_login")
  isActive                  Boolean   @default(true) @map("is_active")
  resetPasswordToken        String?   @map("reset_password_token")
  resetPasswordTokenExpires DateTime? @map("reset_password_token_expires")

  // Relations
  dealsCreated        Deal[]             @relation("DealCreator")
  dealsAssigned       Deal[]             @relation("DealAssignee")
  investor            Investor?
  investorsAssigned   Investor[]         @relation("InvestorAssignee")
  communicationsSent  Communication[]    @relation("CommunicationSender")
  vendorOffersCreated VendorOffer[]      @relation("OfferCreator")
  comparablesConfig   ComparablesConfig?

  @@index([email])
  @@index([role])
  @@map("users")
}

// Company Profile - Global company information used across the platform
model CompanyProfile {
  id String @id @default(uuid())

  // Company Details
  companyName    String  @map("company_name")
  companyEmail   String? @map("company_email")
  companyPhone   String? @map("company_phone")
  companyWebsite String? @map("company_website")
  companyAddress String? @map("company_address") @db.Text

  // Branding
  logoUrl        String? @map("logo_url") @db.Text
  logoS3Key      String? @map("logo_s3_key") // For S3 storage
  primaryColor   String  @default("#3b82f6") @map("primary_color") // Hex color
  secondaryColor String  @default("#10b981") @map("secondary_color") // Hex color

  // About
  description String? @db.Text
  tagline     String?

  // Social Media
  linkedinUrl  String? @map("linkedin_url")
  facebookUrl  String? @map("facebook_url")
  twitterUrl   String? @map("twitter_url")
  instagramUrl String? @map("instagram_url")

  // Legal
  companyNumber String? @map("company_number") // Company registration number
  vatNumber     String? @map("vat_number")
  fcaNumber     String? @map("fca_number") // FCA registration if applicable

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("company_profile")
}

model Investor {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Investment Criteria
  preferredAreas String[] @map("preferred_areas") // PostgreSQL array
  minBudget      Int?     @map("min_budget")
  maxBudget      Int?     @map("max_budget")
  minYield       Decimal? @map("min_yield") @db.Decimal(5, 2)
  minBmv         Decimal? @map("min_bmv") @db.Decimal(5, 2)
  strategy       String[] // ['BRRRR', 'BTL', 'Flip']

  // Profile
  experienceLevel String? @map("experience_level") // 'beginner', 'intermediate', 'advanced'
  financingStatus String? @map("financing_status") // 'cash', 'mortgage', 'both'

  // Pipeline Management
  pipelineStage InvestorPipelineStage @default(LEAD) @map("pipeline_stage")
  lastActivityAt DateTime? @map("last_activity_at")
  assignedToId String? @map("assigned_to")
  assignedTo User? @relation("InvestorAssignee", fields: [assignedToId], references: [id])

  // Stats
  dealsPurchased Int     @default(0) @map("deals_purchased")
  totalSpent     Decimal @default(0) @map("total_spent") @db.Decimal(10, 2)
  dealsViewed Int @default(0) @map("deals_viewed")
  packsRequested Int @default(0) @map("packs_requested")
  activeReservationsCount Int @default(0) @map("active_reservations_count")

  // Communication
  emailAlerts Boolean @default(true) @map("email_alerts")
  smsAlerts   Boolean @default(false) @map("sms_alerts")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  dealsSold      Deal[]
  purchases      Purchase[]
  favorites      Favorite[]
  dealViews      DealView[]
  communications Communication[]
  alerts         Alert[]
  reservations   InvestorReservation[]
  packsReceived  InvestorPackDelivery[]
  activities     InvestorActivity[]

  @@index([userId])
  @@index([pipelineStage])
  @@index([assignedToId])
  @@index([lastActivityAt])
  @@map("investors")
}

model Deal {
  id String @id @default(uuid())

  // Property Details
  address      String
  postcode     String?
  latitude     Decimal? @db.Decimal(10, 8)
  longitude    Decimal? @db.Decimal(11, 8)
  propertyType String?  @map("property_type") // 'terraced', 'semi', 'detached', 'flat'
  bedrooms     Int?
  bathrooms    Int?
  squareFeet   Int?     @map("square_feet")

  // Pricing
  askingPrice          Decimal  @map("asking_price") @db.Decimal(10, 2)
  marketValue          Decimal? @map("market_value") @db.Decimal(10, 2)
  estimatedRefurbCost  Decimal? @map("estimated_refurb_cost") @db.Decimal(10, 2)
  afterRefurbValue     Decimal? @map("after_refurb_value") @db.Decimal(10, 2)
  estimatedMonthlyRent Decimal? @map("estimated_monthly_rent") @db.Decimal(10, 2)

  // Metrics
  bmvPercentage      Decimal? @map("bmv_percentage") @db.Decimal(5, 2)
  grossYield         Decimal? @map("gross_yield") @db.Decimal(5, 2)
  netYield           Decimal? @map("net_yield") @db.Decimal(5, 2)
  roi                Decimal? @db.Decimal(5, 2)
  roce               Decimal? @db.Decimal(5, 2)
  dealScore          Int?     @map("deal_score") // 0-100
  dealScoreBreakdown Json?    @map("deal_score_breakdown")

  // Deal Info
  status          DealStatus @default(new)
  statusUpdatedAt DateTime?  @default(now()) @map("status_updated_at")
  statusHistory   Json?      @map("status_history")
  packTier        PackTier?  @map("pack_tier")
  packPrice       Decimal?   @map("pack_price") @db.Decimal(10, 2)

  // Source
  dataSource String? @map("data_source") // 'propertydata', 'manual', 'rightmove'
  externalId String? @map("external_id")
  agentName  String? @map("agent_name")
  agentPhone String? @map("agent_phone")
  listingUrl String? @map("listing_url") @db.Text

  // Team
  assignedToId String? @map("assigned_to")
  assignedTo   User?   @relation("DealAssignee", fields: [assignedToId], references: [id])
  createdById  String? @map("created_by")
  createdBy    User?   @relation("DealCreator", fields: [createdById], references: [id])

  // Sale Details
  soldToId  String?   @map("sold_to")
  soldTo    Investor? @relation(fields: [soldToId], references: [id])
  soldAt    DateTime? @map("sold_at")
  soldPrice Decimal?  @map("sold_price") @db.Decimal(10, 2)

  // Tracking
  viewsCount     Int @default(0) @map("views_count")
  favoritesCount Int @default(0) @map("favorites_count")

  // Timestamps
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  listedAt   DateTime? @map("listed_at")
  archivedAt DateTime? @map("archived_at")

  // Vendor Workflow
  vendor            Vendor?   @relation("VendorDeal")
  offerCount        Int       @default(0) @map("offer_count")
  latestOfferAmount Decimal?  @map("latest_offer_amount") @db.Decimal(10, 2)
  latestOfferDate   DateTime? @map("latest_offer_date")
  offerAcceptedAt   DateTime? @map("offer_accepted_at")

  // Vendor Legal Details
  vendorSolicitorName  String? @map("vendor_solicitor_name")
  vendorSolicitorEmail String? @map("vendor_solicitor_email")
  vendorSolicitorPhone String? @map("vendor_solicitor_phone")

  // Lock-out Agreement
  lockOutAgreementSent   Boolean   @default(false) @map("lock_out_agreement_sent")
  lockOutAgreementSentAt DateTime? @map("lock_out_agreement_sent_at")

  // Investor Pack
  investorPackSent      Boolean   @default(false) @map("investor_pack_sent")
  investorPackSentAt    DateTime? @map("investor_pack_sent_at")
  investorPackSentCount Int       @default(0) @map("investor_pack_sent_count")

  // Investor Reservations
  reservationCount             Int @default(0) @map("reservation_count")
  reservationsWithProofOfFunds Int @default(0) @map("reservations_with_proof_of_funds")

  // Relations
  photos               DealPhoto[]
  documents            DealDocument[]
  comparables          Comparable[]
  purchases            Purchase[]
  favorites            Favorite[]
  dealViews            DealView[]
  communications       Communication[]
  vendorOffers         VendorOffer[]         @relation("VendorOfferDeal")
  investorReservations InvestorReservation[] @relation("InvestorReservationDeal")
  packDeliveries       InvestorPackDelivery[] @relation("InvestorPackDelivery")

  @@index([status])
  @@index([postcode])
  @@index([dealScore])
  @@index([createdAt])
  @@index([assignedToId])
  @@map("deals")
}

model DealPhoto {
  id         String   @id @default(uuid())
  dealId     String   @map("deal_id")
  deal       Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  s3Key      String   @map("s3_key") @db.VarChar(500)
  s3Url      String   @map("s3_url") @db.Text
  caption    String?  @db.Text
  isCover    Boolean  @default(false) @map("is_cover")
  sortOrder  Int      @default(0) @map("sort_order")
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  @@index([dealId])
  @@map("deal_photos")
}

model DealDocument {
  id           String       @id @default(uuid())
  dealId       String       @map("deal_id")
  deal         Deal         @relation(fields: [dealId], references: [id], onDelete: Cascade)
  documentType DocumentType @map("document_type")
  s3Key        String       @map("s3_key") @db.VarChar(500)
  s3Url        String       @map("s3_url") @db.Text
  filename     String?
  fileSize     Int?         @map("file_size")
  uploadedAt   DateTime     @default(now()) @map("uploaded_at")

  @@index([dealId])
  @@index([documentType])
  @@map("deal_documents")
}

model Comparable {
  id           String    @id @default(uuid())
  dealId       String    @map("deal_id")
  deal         Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  address      String?
  postcode     String?
  salePrice    Decimal?  @map("sale_price") @db.Decimal(10, 2)
  saleDate     DateTime? @map("sale_date") @db.Date
  bedrooms     Int?
  propertyType String?   @map("property_type")
  distanceKm   Decimal?  @map("distance_km") @db.Decimal(5, 2)
  source       String? // 'propertydata', 'land_registry'
  createdAt    DateTime  @default(now()) @map("created_at")

  @@index([dealId])
  @@map("comparables")
}

model Purchase {
  id         String   @id @default(uuid())
  dealId     String   @map("deal_id")
  deal       Deal     @relation(fields: [dealId], references: [id])
  investorId String   @map("investor_id")
  investor   Investor @relation(fields: [investorId], references: [id])

  // Payment
  amount          Decimal       @db.Decimal(10, 2)
  stripePaymentId String?       @map("stripe_payment_id")
  stripeInvoiceId String?       @map("stripe_invoice_id")
  paymentStatus   PaymentStatus @default(pending) @map("payment_status")

  // Access
  packDownloaded  Boolean   @default(false) @map("pack_downloaded")
  downloadCount   Int       @default(0) @map("download_count")
  firstDownloadAt DateTime? @map("first_download_at")

  // Follow-up
  investorProceeded Boolean? @map("investor_proceeded")
  feedbackRating    Int?     @map("feedback_rating") // 1-5 stars
  feedbackComment   String?  @map("feedback_comment") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([dealId])
  @@index([investorId])
  @@index([paymentStatus])
  @@map("purchases")
}

model Favorite {
  id         String   @id @default(uuid())
  investorId String   @map("investor_id")
  investor   Investor @relation(fields: [investorId], references: [id], onDelete: Cascade)
  dealId     String   @map("deal_id")
  deal       Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([investorId, dealId])
  @@index([investorId])
  @@index([dealId])
  @@map("favorites")
}

model DealView {
  id         String    @id @default(uuid())
  dealId     String    @map("deal_id")
  deal       Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  investorId String?   @map("investor_id")
  investor   Investor? @relation(fields: [investorId], references: [id], onDelete: Cascade)
  viewedAt   DateTime  @default(now()) @map("viewed_at")

  @@index([dealId])
  @@index([investorId])
  @@index([viewedAt])
  @@map("deal_views")
}

model Communication {
  id         String    @id @default(uuid())
  investorId String?   @map("investor_id")
  investor   Investor? @relation(fields: [investorId], references: [id], onDelete: Cascade)
  vendorId   String?   @map("vendor_id")
  vendor     Vendor?   @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  dealId     String?   @map("deal_id")
  deal       Deal?     @relation(fields: [dealId], references: [id], onDelete: SetNull)

  type    CommunicationType
  subject String?
  message String?           @db.Text

  // Email specific
  emailSent    Boolean @default(false) @map("email_sent")
  emailOpened  Boolean @default(false) @map("email_opened")
  emailClicked Boolean @default(false) @map("email_clicked")

  // SMS specific (for vendor AI conversations)
  smsMessageId String? @map("sms_message_id")
  smsDirection String? @map("sms_direction") // 'inbound', 'outbound'
  smsProvider  String? @map("sms_provider") // 'twilio', 'messagebird', etc.

  sentById String?  @map("sent_by")
  sentBy   User?    @relation("CommunicationSender", fields: [sentById], references: [id])
  sentAt   DateTime @default(now()) @map("sent_at")

  @@index([investorId])
  @@index([vendorId])
  @@index([dealId])
  @@index([type])
  @@map("communications")
}

model Alert {
  id         String   @id @default(uuid())
  investorId String   @map("investor_id")
  investor   Investor @relation(fields: [investorId], references: [id], onDelete: Cascade)

  name     String
  criteria Json // Store filter criteria as JSONB in PostgreSQL

  isActive      Boolean   @default(true) @map("is_active")
  lastTriggered DateTime? @map("last_triggered")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([investorId])
  @@index([isActive])
  @@map("alerts")
}

model PropertyDataCache {
  id          String   @id @default(uuid())
  address     String
  postcode    String?
  data        Json // Full PropertyData API response
  creditsUsed Int      @default(1) @map("credits_used")
  fetchedAt   DateTime @default(now()) @map("fetched_at")
  expiresAt   DateTime @map("expires_at") // Cache for 30 days

  @@unique([address, postcode])
  @@index([address])
  @@index([postcode])
  @@index([expiresAt])
  @@map("property_data_cache")
}

model Vendor {
  id     String  @id @default(uuid())
  dealId String? @unique @map("deal_id")
  deal   Deal?   @relation("VendorDeal", fields: [dealId], references: [id], onDelete: SetNull)

  // Contact Details
  firstName String? @map("first_name")
  lastName  String? @map("last_name")
  email     String?
  phone     String
  address   String?

  // Source Tracking
  source       String  @default("facebook_ad")
  facebookAdId String? @map("facebook_ad_id")
  campaignId   String? @map("campaign_id")

  // Initial Details
  askingPrice     Decimal? @map("asking_price") @db.Decimal(10, 2)
  propertyAddress String?  @map("property_address")
  reasonForSale   String?  @map("reason_for_sale") @db.Text

  // Status Tracking
  status      VendorStatus @default(contacted)
  qualifiedAt DateTime?    @map("qualified_at")
  lockedOutAt DateTime?    @map("locked_out_at")

  // Legal Details
  solicitorName  String? @map("solicitor_name")
  solicitorEmail String? @map("solicitor_email")
  solicitorPhone String? @map("solicitor_phone")

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  aiConversations VendorAIConversation[]
  offers          VendorOffer[]
  Communication   Communication[]

  @@index([phone])
  @@index([email])
  @@index([status])
  @@index([facebookAdId])
  @@map("vendors")
}

model VendorAIConversation {
  id       String @id @default(uuid())
  vendorId String @map("vendor_id")
  vendor   Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  // Message Details
  direction  ConversationDirection
  message    String                @db.Text
  aiResponse String?               @map("ai_response") @db.Text

  // Context
  intent     String?
  confidence Decimal? @db.Decimal(5, 2)

  // Media
  videoSent Boolean @default(false) @map("video_sent")
  videoUrl  String? @map("video_url") @db.Text

  // Metadata
  messageId String? @map("message_id")
  provider  String?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([vendorId])
  @@index([createdAt])
  @@index([intent])
  @@map("vendor_ai_conversations")
}

model VendorOffer {
  id       String  @id @default(uuid())
  vendorId String  @map("vendor_id")
  vendor   Vendor  @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  dealId   String? @map("deal_id")
  deal     Deal?   @relation("VendorOfferDeal", fields: [dealId], references: [id], onDelete: SetNull)

  // Offer Details
  offerAmount Decimal  @map("offer_amount") @db.Decimal(10, 2)
  offerDate   DateTime @default(now()) @map("offer_date")

  // Status
  status             OfferStatus     @default(pending)
  vendorDecision     VendorDecision?
  vendorDecisionDate DateTime?       @map("vendor_decision_date")
  vendorNotes        String?         @map("vendor_notes") @db.Text

  // Follow-up
  moreInfoRequested  Boolean  @default(false) @map("more_info_requested")
  videoSent          Boolean  @default(false) @map("video_sent")
  counterOfferAmount Decimal? @map("counter_offer_amount") @db.Decimal(10, 2)

  // Sent By
  createdById String? @map("created_by")
  createdBy   User?   @relation("OfferCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([vendorId])
  @@index([dealId])
  @@index([status])
  @@index([offerDate])
  @@map("vendor_offers")
}

model InvestorReservation {
  id         String   @id @default(uuid())
  investorId String   @map("investor_id")
  investor   Investor @relation(fields: [investorId], references: [id], onDelete: Cascade)
  dealId     String   @map("deal_id")
  deal       Deal     @relation("InvestorReservationDeal", fields: [dealId], references: [id], onDelete: Cascade)

  // Reservation Details
  reservationFee Decimal   @map("reservation_fee") @db.Decimal(10, 2)
  feePaid        Boolean   @default(false) @map("fee_paid")
  feePaymentId   String?   @map("fee_payment_id")
  feePaidAt      DateTime? @map("fee_paid_at")

  // Proof of Funds
  proofOfFundsProvided      Boolean   @default(false) @map("proof_of_funds_provided")
  proofOfFundsDocumentS3Key String?   @map("proof_of_funds_document_s3_key")
  proofOfFundsVerified      Boolean   @default(false) @map("proof_of_funds_verified")
  proofOfFundsVerifiedAt    DateTime? @map("proof_of_funds_verified_at")
  proofOfFundsVerifiedBy    String?   @map("proof_of_funds_verified_by")

  // Legal Details
  solicitorName  String? @map("solicitor_name")
  solicitorEmail String? @map("solicitor_email")
  solicitorPhone String? @map("solicitor_phone")
  solicitorFirm  String? @map("solicitor_firm")

  // Lock-out Agreement
  lockOutAgreementSent          Boolean   @default(false) @map("lock_out_agreement_sent")
  lockOutAgreementSentAt        DateTime? @map("lock_out_agreement_sent_at")
  lockOutAgreementSigned        Boolean   @default(false) @map("lock_out_agreement_signed")
  lockOutAgreementSignedAt      DateTime? @map("lock_out_agreement_signed_at")
  lockOutAgreementDocumentS3Key String?   @map("lock_out_agreement_document_s3_key")

  // Status
  status ReservationStatus @default(pending)

  // Notes
  notes String? @db.Text

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  completedAt DateTime? @map("completed_at")

  @@unique([investorId, dealId])
  @@index([investorId])
  @@index([dealId])
  @@index([status])
  @@map("investor_reservations")
}

// ============================================================================
// VENDOR PIPELINE MODELS
// ============================================================================

model VendorLead {
  id String @id @default(uuid())

  // Lead Source
  facebookLeadId String? @unique @map("facebook_lead_id")
  leadSource     String  @default("facebook_ads") @map("lead_source")
  campaignId     String? @map("campaign_id")

  // Vendor Information
  vendorName    String  @map("vendor_name")
  vendorPhone   String  @map("vendor_phone")
  vendorEmail   String? @map("vendor_email")
  vendorAddress String? @map("vendor_address") @db.Text

  // Property Details
  propertyAddress       String?            @map("property_address") @db.Text
  propertyPostcode      String?            @map("property_postcode")
  askingPrice           Decimal?           @map("asking_price") @db.Decimal(12, 2)
  propertyType          String?            @map("property_type")
  bedrooms              Int?
  bathrooms             Int?
  squareFeet            Int?               @map("square_feet")
  condition             PropertyCondition?
  estimatedMonthlyRent  Decimal?           @map("estimated_monthly_rent") @db.Decimal(10, 2)
  estimatedAnnualRent   Decimal?           @map("estimated_annual_rent") @db.Decimal(10, 2)
  rentPerSqFt           Decimal?           @map("rent_per_sq_ft") @db.Decimal(5, 2)
  localAverageRent      Decimal?           @map("local_average_rent") @db.Decimal(10, 2)
  rentConfidence        String?            @map("rent_confidence") // 'HIGH', 'MEDIUM', 'LOW'

  // Workflow Status
  pipelineStage     PipelineStage @default(NEW_LEAD) @map("pipeline_stage")
  conversationState Json?         @default("{}") @map("conversation_state")

  // AI Conversation Data
  aiConversationHistory Json?          @default("[]") @map("ai_conversation_history")
  motivationScore       Int?           @map("motivation_score")
  urgencyLevel          UrgencyLevel?  @map("urgency_level")
  reasonForSelling      ReasonForSale? @map("reason_for_selling")
  timelineDays          Int?           @map("timeline_days")
  competingOffers       Boolean        @default(false) @map("competing_offers")

  // Deal Validation
  bmvScore             Decimal?  @map("bmv_score") @db.Decimal(5, 2)
  estimatedMarketValue Decimal?  @map("estimated_market_value") @db.Decimal(12, 2)
  estimatedRefurbCost  Decimal?  @map("estimated_refurb_cost") @db.Decimal(12, 2)
  profitPotential      Decimal?  @map("profit_potential") @db.Decimal(12, 2)
  validationPassed     Boolean?  @map("validation_passed")
  validationNotes      String?   @map("validation_notes") @db.Text
  validatedAt          DateTime? @map("validated_at")

  // Comparables Tracking
  comparablesCount        Int?      @default(0) @map("comparables_count")
  comparablesFetchedAt    DateTime? @map("comparables_fetched_at")
  comparablesSearchRadius Int?      @default(3) @map("comparables_search_radius")
  avgComparablePrice      Decimal?  @map("avg_comparable_price") @db.Decimal(10, 2)
  comparablesConfidence   String?   @map("comparables_confidence") // 'HIGH', 'MEDIUM', 'LOW'

  // Offer Management
  offerAmount     Decimal?  @map("offer_amount") @db.Decimal(12, 2)
  offerPercentage Decimal?  @map("offer_percentage") @db.Decimal(5, 2)
  offerSentAt     DateTime? @map("offer_sent_at")
  offerAcceptedAt DateTime? @map("offer_accepted_at")
  offerRejectedAt DateTime? @map("offer_rejected_at")
  rejectionReason String?   @map("rejection_reason") @db.Text
  retryCount      Int       @default(0) @map("retry_count")
  nextRetryAt     DateTime? @map("next_retry_at")

  // Retry Tracking
  videoSent   Boolean   @default(false) @map("video_sent")
  videoSentAt DateTime? @map("video_sent_at")
  videoUrl    String?   @map("video_url") @db.Text

  // Solicitor Details
  solicitorName            String?   @map("solicitor_name")
  solicitorFirm            String?   @map("solicitor_firm")
  solicitorPhone           String?   @map("solicitor_phone")
  solicitorEmail           String?   @map("solicitor_email")
  lockoutAgreementSent     Boolean   @default(false) @map("lockout_agreement_sent")
  lockoutAgreementSentAt   DateTime? @map("lockout_agreement_sent_at")
  lockoutAgreementSigned   Boolean   @default(false) @map("lockout_agreement_signed")
  lockoutAgreementSignedAt DateTime? @map("lockout_agreement_signed_at")
  lockoutAgreementS3Key    String?   @map("lockout_agreement_s3_key")

  // Link to Deal
  dealId String? @map("deal_id")

  // Investor Pack Tracking
  investorPackGenerationCount Int       @default(0) @map("investor_pack_generation_count")
  lastInvestorPackGeneratedAt DateTime? @map("last_investor_pack_generated_at")

  // Timestamps
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  lastContactAt         DateTime? @map("last_contact_at")
  conversationStartedAt DateTime? @map("conversation_started_at")
  dealClosedAt          DateTime? @map("deal_closed_at")

  // Relations
  smsMessages          SMSMessage[]
  pipelineEvents       PipelineEvent[]
  offerRetries         OfferRetry[]
  comparableProperties ComparableProperty[]
  comparablesSnapshots ComparablesSnapshot[]

  @@index([pipelineStage])
  @@index([createdAt])
  @@index([vendorPhone])
  @@index([facebookLeadId])
  @@index([dealId])
  @@index([motivationScore])
  @@index([nextRetryAt])
  @@map("vendor_leads")
}

model SMSMessage {
  id           String     @id @default(uuid())
  vendorLeadId String     @map("vendor_lead_id")
  vendorLead   VendorLead @relation(fields: [vendorLeadId], references: [id], onDelete: Cascade)

  // Message Details
  direction  SMSDirection
  messageSid String?      @unique @map("message_sid")

  // Phone Numbers
  fromNumber  String? @map("from_number")
  toNumber    String? @map("to_number")
  messageBody String  @map("message_body") @db.Text

  // AI Context
  aiGenerated        Boolean  @default(false) @map("ai_generated")
  aiPrompt           String?  @map("ai_prompt") @db.Text
  aiResponseMetadata Json?    @map("ai_response_metadata")
  intentDetected     String?  @map("intent_detected")
  confidenceScore    Decimal? @map("confidence_score") @db.Decimal(5, 2)

  // Status Tracking
  status       SMSStatus?
  errorCode    String?    @map("error_code")
  errorMessage String?    @map("error_message") @db.Text

  // Timestamps
  sentAt      DateTime  @default(now()) @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([vendorLeadId])
  @@index([createdAt])
  @@index([direction])
  @@index([status])
  @@index([messageSid])
  @@map("sms_messages")
}

model PipelineMetric {
  id String @id @default(uuid())

  date DateTime @unique @db.Date

  // Lead Counts by Stage
  newLeads       Int @default(0) @map("new_leads")
  inConversation Int @default(0) @map("in_conversation")
  validated      Int @default(0)
  offersMade     Int @default(0) @map("offers_made")
  offersAccepted Int @default(0) @map("offers_accepted")
  offersRejected Int @default(0) @map("offers_rejected")
  dealsClosed    Int @default(0) @map("deals_closed")
  deadLeads      Int @default(0) @map("dead_leads")

  // Conversion Rates (percentages)
  conversationToOfferRate Decimal? @map("conversation_to_offer_rate") @db.Decimal(5, 2)
  offerAcceptanceRate     Decimal? @map("offer_acceptance_rate") @db.Decimal(5, 2)
  overallConversionRate   Decimal? @map("overall_conversion_rate") @db.Decimal(5, 2)

  // Timing Metrics (hours/days)
  avgConversationDurationHours Decimal? @map("avg_conversation_duration_hours") @db.Decimal(10, 2)
  avgTimeToOfferHours          Decimal? @map("avg_time_to_offer_hours") @db.Decimal(10, 2)
  avgTimeToCloseDays           Decimal? @map("avg_time_to_close_days") @db.Decimal(10, 2)

  // Financial Metrics
  totalOfferValue      Decimal? @map("total_offer_value") @db.Decimal(15, 2)
  totalAcceptedValue   Decimal? @map("total_accepted_value") @db.Decimal(15, 2)
  avgBmvPercentage     Decimal? @map("avg_bmv_percentage") @db.Decimal(5, 2)
  totalProfitPotential Decimal? @map("total_profit_potential") @db.Decimal(15, 2)

  // AI Performance Metrics
  avgMotivationScore         Decimal? @map("avg_motivation_score") @db.Decimal(3, 1)
  avgMessagesPerConversation Decimal? @map("avg_messages_per_conversation") @db.Decimal(5, 2)
  aiResponseTimeMs           Int?     @map("ai_response_time_ms")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([date])
  @@map("pipeline_metrics")
}

model PipelineEvent {
  id           String     @id @default(uuid())
  vendorLeadId String     @map("vendor_lead_id")
  vendorLead   VendorLead @relation(fields: [vendorLeadId], references: [id], onDelete: Cascade)

  eventType String   @map("event_type")
  fromStage String?  @map("from_stage")
  toStage   String?  @map("to_stage")
  details   Json?    @default("{}")
  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([vendorLeadId])
  @@index([eventType])
  @@index([createdAt])
  @@map("pipeline_events")
}

model OfferRetry {
  id           String     @id @default(uuid())
  vendorLeadId String     @map("vendor_lead_id")
  vendorLead   VendorLead @relation(fields: [vendorLeadId], references: [id], onDelete: Cascade)

  retryNumber         Int       @map("retry_number")
  originalOfferAmount Decimal   @map("original_offer_amount") @db.Decimal(12, 2)
  adjustedOfferAmount Decimal?  @map("adjusted_offer_amount") @db.Decimal(12, 2)
  messageSent         String?   @map("message_sent") @db.Text
  smsMessageId        String?   @map("sms_message_id")
  scheduledFor        DateTime  @map("scheduled_for")
  sentAt              DateTime? @map("sent_at")
  vendorResponse      String?   @map("vendor_response")
  responseReceivedAt  DateTime? @map("response_received_at")
  createdAt           DateTime  @default(now()) @map("created_at")

  @@index([vendorLeadId])
  @@index([scheduledFor])
  @@map("offer_retries")
}

model FacebookLeadSync {
  id             String    @id @default(uuid())
  facebookLeadId String    @unique @map("facebook_lead_id")
  vendorLeadId   String?   @map("vendor_lead_id")
  leadData       Json?     @map("lead_data")
  syncedAt       DateTime  @default(now()) @map("synced_at")
  processedAt    DateTime? @map("processed_at")
  errorMessage   String?   @map("error_message") @db.Text
  createdAt      DateTime  @default(now()) @map("created_at")

  @@index([facebookLeadId])
  @@index([vendorLeadId])
  @@index([processedAt])
  @@map("facebook_lead_sync")
}

// Comparables Configuration - User-specific settings for comparable property searches
model ComparablesConfig {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  searchRadius         Int      @default(3) @map("search_radius") // miles
  maxResults           Int      @default(5) @map("max_results") // number of comparables
  maxAgeMonths         Int      @default(12) @map("max_age_months") // max age of sold properties
  bedroomTolerance     Int      @default(1) @map("bedroom_tolerance") // Â±N bedrooms
  includePropertyTypes String[] @map("include_property_types") // empty = all types
  minConfidenceScore   Decimal  @default(0.7) @map("min_confidence_score") @db.Decimal(3, 2) // 0.0 to 1.0

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("comparables_config")
}

// Comparable Property - Individual sold property used for comparison
model ComparableProperty {
  id           String     @id @default(uuid())
  vendorLeadId String     @map("vendor_lead_id")
  vendorLead   VendorLead @relation(fields: [vendorLeadId], references: [id], onDelete: Cascade)

  // Property Details
  address      String
  postcode     String?
  salePrice    Decimal  @map("sale_price") @db.Decimal(10, 2)
  saleDate     DateTime @map("sale_date")
  bedrooms     Int?
  bathrooms    Int?
  propertyType String?  @map("property_type")
  squareFeet   Int?     @map("square_feet")

  // Location & Market Data
  distance        Decimal? @db.Decimal(5, 2) // miles from target property
  daysOnMarket    Int?     @map("days_on_market")
  priceReductions Int      @default(0) @map("price_reductions")

  // Rental Data (from PropertyData API)
  monthlyRent           Decimal? @map("monthly_rent") @db.Decimal(10, 2) // Average monthly rent
  weeklyRent            Decimal? @map("weekly_rent") @db.Decimal(10, 2) // Average weekly rent
  rentalYield           Decimal? @map("rental_yield") @db.Decimal(5, 2) // Annual yield percentage
  rentalYieldMin        Decimal? @map("rental_yield_min") @db.Decimal(5, 2) // Min yield (70% confidence range)
  rentalYieldMax        Decimal? @map("rental_yield_max") @db.Decimal(5, 2) // Max yield (70% confidence range)
  areaAverageRent       Decimal? @map("area_average_rent") @db.Decimal(10, 2) // Area average for comparison

  // Source Information
  listingSource       String? @map("listing_source") // 'rightmove', 'zoopla', 'onthemarket', 'multiple'
  listingUrl          String? @map("listing_url") @db.Text // Primary portal link (e.g., Rightmove)
  listingUrlSecondary String? @map("listing_url_secondary") @db.Text // Secondary portal link (e.g., Zoopla)
  propertyDataId      String? @map("propertydata_id") // PropertyData property ID

  // Analysis
  confidence Decimal @default(1.0) @db.Decimal(3, 2) // 0.0 to 1.0 confidence score
  notes      String? @db.Text

  // Metadata
  fetchedAt DateTime @default(now()) @map("fetched_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([vendorLeadId])
  @@index([postcode])
  @@index([saleDate])
  @@index([fetchedAt])
  @@index([rentalYield])
  @@map("comparable_properties")
}

// Comparables Snapshot - Historical tracking of comparables over time
model ComparablesSnapshot {
  id           String     @id @default(uuid())
  vendorLeadId String     @map("vendor_lead_id")
  vendorLead   VendorLead @relation(fields: [vendorLeadId], references: [id], onDelete: Cascade)

  snapshotDate     DateTime @map("snapshot_date")
  avgPrice         Decimal? @map("avg_price") @db.Decimal(10, 2)
  comparablesCount Int      @map("comparables_count")
  searchRadius     Int      @map("search_radius")
  confidence       String? // 'HIGH', 'MEDIUM', 'LOW'
  data             Json? // Full comparables data snapshot

  createdAt DateTime @default(now()) @map("created_at")

  @@index([vendorLeadId])
  @@index([snapshotDate])
  @@map("comparables_snapshots")
}

// Investor Pack Templates - Customizable templates for generating investor packs
model InvestorPackTemplate {
  id          String   @id @default(uuid())
  name        String // e.g., "Premium Template", "Quick Overview", "Detailed Analysis"
  description String?  @db.Text
  isDefault   Boolean  @default(false) @map("is_default")
  isActive    Boolean  @default(true) @map("is_active")

  // Template Type
  templateType String @default("single") @map("template_type") // '4-part' or 'single'

  // Template Configuration
  coverStyle     String?  @map("cover_style") // 'modern', 'classic', 'minimal' (for single templates)
  colorScheme    String   @default("blue") @map("color_scheme") // 'blue', 'green', 'purple', 'gold', 'dark'
  orientation    String   @default("landscape") // 'landscape' or 'portrait'
  // Company info now comes from global CompanyProfile table

  // Single Template Configuration (for backward compatibility)
  sections Json @default("[]")
  metricsConfig Json @default("{}") @map("metrics_config")

  // 4-Part Template Configuration (The Investables Method)
  part1Enabled  Boolean @default(true) @map("part1_enabled")
  part1Sections Json    @default("[]") @map("part1_sections")
  part2Enabled  Boolean @default(true) @map("part2_enabled")
  part2Sections Json    @default("[]") @map("part2_sections")
  part3Enabled  Boolean @default(true) @map("part3_enabled")
  part3Sections Json    @default("[]") @map("part3_sections")
  part4Enabled  Boolean @default(true) @map("part4_enabled")
  part4Sections Json    @default("[]") @map("part4_sections")
  includeRiskWarnings Boolean @default(true) @map("include_risk_warnings")

  // Custom Fields
  customFields Json? @map("custom_fields") // Additional user-defined fields

  // Usage Statistics
  usageCount Int      @default(0) @map("usage_count")
  lastUsedAt DateTime? @map("last_used_at")

  // Ownership
  createdById String? @map("created_by")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  generatedPacks InvestorPackGeneration[]

  @@index([isDefault])
  @@index([isActive])
  @@index([createdById])
  @@map("investor_pack_templates")
}

// Investor Pack Generation Log - Track all generated investor packs
model InvestorPackGeneration {
  id              String   @id @default(uuid())
  templateId      String?  @map("template_id")
  template        InvestorPackTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  // Source
  vendorLeadId    String?  @map("vendor_lead_id")
  dealId          String?  @map("deal_id")

  // Property Info (snapshot at generation time)
  propertyAddress String   @map("property_address")
  askingPrice     Decimal  @map("asking_price") @db.Decimal(10, 2)

  // Generation Details
  generatedById   String   @map("generated_by")
  fileSize        Int?     @map("file_size") // bytes
  pageCount       Int?     @map("page_count")

  // Delivery
  sentToEmail     String?  @map("sent_to_email")
  sentAt          DateTime? @map("sent_at")
  viewedAt        DateTime? @map("viewed_at")
  downloadedAt    DateTime? @map("downloaded_at")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  deliveries      InvestorPackDelivery[]

  @@index([templateId])
  @@index([vendorLeadId])
  @@index([dealId])
  @@index([generatedById])
  @@index([createdAt])
  @@map("investor_pack_generations")
}

// ============================================================================
// INVESTOR PACK DELIVERY & ACTIVITY TRACKING
// ============================================================================

// Track which investor received which investor pack
model InvestorPackDelivery {
  id String @id @default(uuid())

  // Links
  investorId String @map("investor_id")
  investor Investor @relation(fields: [investorId], references: [id], onDelete: Cascade)

  dealId String @map("deal_id")
  deal Deal @relation("InvestorPackDelivery", fields: [dealId], references: [id], onDelete: Cascade)

  generationId String? @map("generation_id")
  generation InvestorPackGeneration? @relation(fields: [generationId], references: [id], onDelete: SetNull)

  // Delivery Details
  deliveryMethod String @default("email") @map("delivery_method") // email, download, manual
  recipientEmail String? @map("recipient_email")
  partNumber Int? @map("part_number") // For 4-part templates: 1, 2, 3, 4. NULL for single pack

  // Tracking
  sentAt DateTime @default(now()) @map("sent_at")
  viewedAt DateTime? @map("viewed_at")
  downloadedAt DateTime? @map("downloaded_at")
  viewCount Int @default(0) @map("view_count")
  downloadCount Int @default(0) @map("download_count")

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([investorId, dealId, generationId, partNumber])
  @@index([investorId])
  @@index([dealId])
  @@index([generationId])
  @@index([sentAt])
  @@index([partNumber])
  @@map("investor_pack_deliveries")
}

// Track all investor activities for pipeline management
model InvestorActivity {
  id String @id @default(uuid())

  // Links
  investorId String @map("investor_id")
  investor Investor @relation(fields: [investorId], references: [id], onDelete: Cascade)

  // Activity Details
  activityType InvestorActivityType @map("activity_type")
  description String? @db.Text

  // Related entities (optional)
  dealId String? @map("deal_id")
  reservationId String? @map("reservation_id")
  packDeliveryId String? @map("pack_delivery_id")

  // Metadata
  metadata Json? // Store additional data like previous/new values, etc.

  // Who triggered (if system or admin action)
  triggeredById String? @map("triggered_by")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([investorId])
  @@index([activityType])
  @@index([dealId])
  @@index([createdAt])
  @@map("investor_activities")
}
